
## Joining database tables  

### Schema Overview

![](https://raw.githubusercontent.com/ebimodeling/betydb_manuscript/master/figures/gcbb12420-fig-0001.png)

### Define Join

```{r}

library(dplyr)
library(tidyr)
library(traits)
year = lubridate::year

betyurl="https://terraref.ncsa.illinois.edu/bety/"
betykey="9999999999999999999999999999999999999999"

## query and join tables
species <- (betydb_query(table="species", limit="none", betyurl=betyurl, key=betykey, api_version="beta")
  %>% select(specie_id = id, scientificname, genus))

# Regex is to convert geometry column to lat/long --
# starts out as e.g. "POINT(40.11, -88.22, 223)"
sites <- (betydb_query(table="sites", betyurl=betyurl, key=betykey, api_version="beta")
  %>% extract(
    col = geometry,
    into = c("lat", "lon", "ele"),
    regex = "POINT \\(([-.\\d]+) ([-.\\d]+) ([-.\\d]+)\\)",
    convert=TRUE)
  %>% select(site_id = id, lat, lon, ele, sitename, city, country))


citations <- (betydb_query(table="citations", betyurl=betyurl, key=betykey, api_version="beta")
  %>% select(citation_id = id, author, year, title))

# Fails because terraref BETY's yields table is empty
# Succeeds if betyurl="https://www.betydb.org/" (with a valid key...)
yields = (betydb_query(table="yields", betyurl=betyurl, key=betykey, api_version="beta")
  %>% select(
    id, date, mean,
    n, statname, stat,
    site_id, specie_id, treatment_id,
    citation_id, cultivar_id)
  %>% left_join(species, by = 'specie_id')
  %>% left_join(sites, by = 'site_id')
    %>% left_join(citations, by = 'citation_id'))

```

Let's do the manual equivalent of a cross-table join. BETY actually does contain a `managements_treatments` view that would make this faster and easier, but it is not (yet) exposed via API, so let's use it as an example of how to create your own join.

The key idea here is that each treatment is associated with some (possibly many) managements, but the treatments table only reports the number of associated managements. To see the management IDs themselves, we need to query an individual treatment ID. So, we retrieve one table, then iterate over each row extracting the foreign keys for the other table. This requires an API call for every treatment, so beware that it is likely to be slow!

```r
treatments <- (betydb_query(table = 'treatments', betyurl=betyurl, key=betykey, api_version="beta")
  %>% select(treatment_id = id , name, definition, control))

get_mgid <- function(trtid){
  betydb_item(id=trtid, table="treatments", betyurl=betyurl, key=betykey, api_version="beta")$managements$management.id
}

managements_treatments <- (treatments 
  %>% group_by(treatment_id)
  %>% do(management_id = get_mgid(.$treatment_id))
  %>% unnest())

managements <- (betydb_query(table = 'managements', betyurl=betyurl, key=betykey, api_version="beta")
  %>% filter(mgmttype %in% c('fertilizer_N', 'fertilizer_N_rate', 'planting', 'irrigation'))
  %>% select(management_id = id, date, mgmttype, level, units)
  %>% left_join(managements_treatments, by = 'management_id')
  %>% left_join(treatments, by = 'treatment_id'))

planting <- (managements
  %>% filter(mgmttype == "planting")
  %>% select(treatment_id, planting_date = date, nrate = level))

grass_yields <- (yields
  %>% filter(genus %in% c('Miscanthus', 'Panicum'))
  %>% left_join(planting, by = 'treatment_id')
  %>% collect
  %>% replace_na(replace=list(nrate = 0))
  %>% mutate(
    age = year(date) - year(planting_date),
    SE = case_when(
      .$statname == "SE" ~ .$stat,
      .$statname == 'SD' ~ .$stat / sqrt(.$n),
      TRUE ~ NA_real_),
    continent = case_when(
      .$lon < -30 ~ "united_states",
      .$lon < 75 ~ "europe",
      TRUE ~ "asia"))
    %>% filter(!duplicated(.)))

ggplot(data = grass_yields, aes(lon,lat)) + 
  geom_point(aes(color = genus, size = mean), 
             alpha = 0.1)
```
